package com.backend.controller;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import com.backend.dtos.DoctorDTO;
import com.backend.dtos.MedicalRecordDownloadDTO;
import com.backend.dtos.MedicalRecordResponseDTO;
import com.backend.dtos.MedicalRecordViewDTO;
import com.backend.dtos.NurseResponseDto;
import com.backend.dtos.PatientDTO;
import com.backend.entities.MedicalRecordEntity;
import com.backend.service.MedicalRecordService;
import com.backend.service.NurseService;
import com.backend.service.PatientService;


@RestController
@RequestMapping("/api/admin")
@CrossOrigin(origins = "http://localhost:5173")
public class AdminController {

	
	@Autowired
	private MedicalRecordService medicalRecordService;
	
	@Autowired
	private PatientService patientService;

	@Autowired
	private NurseService nurseService;

	
	//Get All Patients
	@GetMapping("/patients")
	public List<PatientDTO> getAllPatients() {
	    return patientService.getAllPatients();
	}
	
	
	//Get All Doctors
	@GetMapping("/doctors")
	public List<DoctorDTO> getAllDoctors() {
	    return patientService.getAllDoctors();
	}
	
	
	//Get All Medical Records --> ADMIN
	@GetMapping("/medical-records")
	public ResponseEntity<List<MedicalRecordViewDTO>> getAllMedicalRecords() {
	    return ResponseEntity.ok(medicalRecordService.getAllMedicalRecords());
	}
	
	
	// DOWNLOAD MEDICAL RECORD
    @GetMapping("/medical-records/{recordId}/download")
    public ResponseEntity<byte[]> download(@PathVariable Long recordId) {

        MedicalRecordDownloadDTO dto =
                medicalRecordService.downloadMedicalRecord(recordId);

        return ResponseEntity.ok()
                .header(HttpHeaders.CONTENT_DISPOSITION,
                        "attachment; filename=\"" + dto.getFileName() + "\"")
                .contentType(MediaType.APPLICATION_OCTET_STREAM)
                .body(dto.getFileData());
    }
	
	//Add Medical Records - Admin
	
	@PostMapping(value = "/add-medical-record", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
	public ResponseEntity<String> addMedicalRecord(@RequestParam Long appointmentId, @RequestParam String recordType, @RequestParam MultipartFile file){
		
		medicalRecordService.saveMedicalRecord(appointmentId, recordType, file);
		
		return ResponseEntity.ok("Medical record added successfully");
	}
	
	
	//Search Medical Records by patient, doctor or title --> ADMIN
	@GetMapping("/search")
	public ResponseEntity<List<MedicalRecordEntity>> searchRecords(
            @RequestParam(required = false) String patientName,
            @RequestParam(required = false) String doctorName,
            @RequestParam(required = false) String recordType) {

        return ResponseEntity.ok(
                medicalRecordService.searchMedicalRecords(
                        patientName,
                        doctorName,
                        recordType
                )
        );
    }
	
	//Search Patient's - ALL (UI) --> ADMIN
	@GetMapping("/patients/name")
	public ResponseEntity<List<String>> getPatientNames(){
		return ResponseEntity.ok(patientService.getAllPatientNames());
	}
	
	
	//Get All Nurses - ADMIN (NURSES)
	@GetMapping("/nurses")
	public ResponseEntity<List<NurseResponseDto>> getAllNurses(){
		
		return ResponseEntity.ok(nurseService.getAllNurses());
	}
}
